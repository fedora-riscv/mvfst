From 18fa8646b86db35cd76476a5a1e948ca93bb8836 Mon Sep 17 00:00:00 2001
From: Michel Lind <salimma@fedoraproject.org>
Date: Tue, 12 Sep 2023 13:59:52 -0500
Subject: [PATCH] Allow versioning shared objects

Signed-off-by: Michel Lind <salimma@fedoraproject.org>
---
 CMakeLists.txt                         |  4 ++++
 quic/CMakeLists.txt                    |  4 ++++
 quic/api/CMakeLists.txt                |  4 ++++
 quic/client/CMakeLists.txt             |  2 ++
 quic/codec/CMakeLists.txt              | 12 ++++++++++++
 quic/common/CMakeLists.txt             | 14 ++++++++++++++
 quic/common/test/CMakeLists.txt        |  2 ++
 quic/congestion_control/CMakeLists.txt |  2 ++
 quic/dsr/CMakeLists.txt                |  8 ++++++++
 quic/fizz/client/CMakeLists.txt        |  2 ++
 quic/fizz/handshake/CMakeLists.txt     |  2 ++
 quic/flowcontrol/CMakeLists.txt        |  2 ++
 quic/handshake/CMakeLists.txt          |  2 ++
 quic/happyeyeballs/CMakeLists.txt      |  2 ++
 quic/logging/CMakeLists.txt            |  2 ++
 quic/loss/CMakeLists.txt               |  2 ++
 quic/observer/CMakeLists.txt           |  2 ++
 quic/server/CMakeLists.txt             |  6 ++++++
 quic/state/CMakeLists.txt              | 18 ++++++++++++++++++
 19 files changed, 92 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2f032305..cf21f8ae 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -7,6 +7,10 @@ cmake_minimum_required(VERSION 3.10)
 
 project(mvfst)
 
+if (NOT DEFINED PACKAGE_VERSION)
+  set(PACKAGE_VERSION "0")
+endif()
+
 set(CMAKE_CXX_STANDARD 17)
 set(CMAKE_CXX_STANDARD_REQUIRED ON)
 set(CMAKE_CXX_EXTENSIONS OFF)
diff --git a/quic/CMakeLists.txt b/quic/CMakeLists.txt
index 5d2989b9..09e17413 100644
--- a/quic/CMakeLists.txt
+++ b/quic/CMakeLists.txt
@@ -8,6 +8,8 @@ add_library(
   QuicConstants.cpp
 )
 
+set_property(TARGET mvfst_constants PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_constants PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -41,6 +43,8 @@ add_library(
   QuicException.cpp
 )
 
+set_property(TARGET mvfst_exception PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_exception PUBLIC
   $<BUILD_INTERFACE:${LIBFIZZ_INCLUDE_DIR}>
diff --git a/quic/api/CMakeLists.txt b/quic/api/CMakeLists.txt
index a6bdab61..2d830f43 100644
--- a/quic/api/CMakeLists.txt
+++ b/quic/api/CMakeLists.txt
@@ -11,6 +11,8 @@ add_library(
   QuicGsoBatchWriters.cpp
 )
 
+set_property(TARGET mvfst_batch_writer PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_batch_writer PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -49,6 +51,8 @@ add_library(
   QuicTransportFunctions.cpp
 )
 
+set_property(TARGET mvfst_transport PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_transport PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/client/CMakeLists.txt b/quic/client/CMakeLists.txt
index 91b1c2b7..4010019d 100644
--- a/quic/client/CMakeLists.txt
+++ b/quic/client/CMakeLists.txt
@@ -12,6 +12,8 @@ add_library(
   connector/QuicConnector.cpp
 )
 
+set_property(TARGET mvfst_client PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_client PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/codec/CMakeLists.txt b/quic/codec/CMakeLists.txt
index 2610b0fc..9797760c 100644
--- a/quic/codec/CMakeLists.txt
+++ b/quic/codec/CMakeLists.txt
@@ -12,6 +12,8 @@ add_library(
   Types.cpp
 )
 
+set_property(TARGET mvfst_codec_types PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_codec_types PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -45,6 +47,8 @@ add_library(
   Decode.cpp
 )
 
+set_property(TARGET mvfst_codec_decode PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_codec_decode PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -75,6 +79,8 @@ add_library(
   PacketNumberCipher.cpp
 )
 
+set_property(TARGET mvfst_codec_packet_number_cipher PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_codec_packet_number_cipher PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -105,6 +111,8 @@ add_library(
   QuicPacketBuilder.cpp
 )
 
+set_property(TARGET mvfst_codec_pktbuilder PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_codec_pktbuilder PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -135,6 +143,8 @@ add_library(
   QuicPacketRebuilder.cpp
 )
 
+set_property(TARGET mvfst_codec_pktrebuilder PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_codec_pktrebuilder PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -175,6 +185,8 @@ add_library(
   QuicWriteCodec.cpp
 )
 
+set_property(TARGET mvfst_codec PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_codec PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/common/CMakeLists.txt b/quic/common/CMakeLists.txt
index 5b694311..946ba2ce 100644
--- a/quic/common/CMakeLists.txt
+++ b/quic/common/CMakeLists.txt
@@ -8,6 +8,8 @@ add_library(
   BufAccessor.cpp
 )
 
+set_property(TARGET mvfst_buf_accessor PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_buf_accessor PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -31,6 +33,8 @@ add_library(
   Timers.cpp
 )
 
+set_property(TARGET mvfst_looper PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_looper PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -53,6 +57,8 @@ add_library(
   BufUtil.cpp
 )
 
+set_property(TARGET mvfst_bufutil PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_bufutil PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -75,6 +81,8 @@ add_library(
   QuicEventBase.cpp
 )
 
+set_property(TARGET mvfst_events PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_events PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -97,6 +105,8 @@ add_library(
   SocketUtil.cpp
 )
 
+set_property(TARGET mvfst_socketutil PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_socketutil PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -119,6 +129,8 @@ add_library(
   TransportKnobs.cpp
 )
 
+set_property(TARGET mvfst_transport_knobs PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_transport_knobs PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -142,6 +154,8 @@ add_library(
   QuicAsyncUDPSocketWrapper.cpp
 )
 
+set_property(TARGET mvfst_async_udp_socket_wrapper PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_async_udp_socket_wrapper PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/common/test/CMakeLists.txt b/quic/common/test/CMakeLists.txt
index 3e3f3efd..9fbd8635 100644
--- a/quic/common/test/CMakeLists.txt
+++ b/quic/common/test/CMakeLists.txt
@@ -15,6 +15,8 @@ add_library(
   CryptoTestUtil.cpp
 )
 
+set_property(TARGET mvfst_test_utils PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_test_utils PUBLIC
   $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
diff --git a/quic/congestion_control/CMakeLists.txt b/quic/congestion_control/CMakeLists.txt
index 86c7836c..e4797efc 100644
--- a/quic/congestion_control/CMakeLists.txt
+++ b/quic/congestion_control/CMakeLists.txt
@@ -23,6 +23,8 @@ add_library(
   TokenlessPacer.cpp
 )
 
+set_property(TARGET mvfst_cc_algo PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_cc_algo PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/dsr/CMakeLists.txt b/quic/dsr/CMakeLists.txt
index 4eabd77f..57d16f4e 100644
--- a/quic/dsr/CMakeLists.txt
+++ b/quic/dsr/CMakeLists.txt
@@ -7,6 +7,8 @@ add_library(
   mvfst_dsr_sender INTERFACE
 )
 
+set_property(TARGET mvfst_dsr_sender PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_dsr_sender INTERFACE
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -18,6 +20,8 @@ add_library(
   Types.cpp
 )
 
+set_property(TARGET mvfst_dsr_types PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_dsr_types PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -47,6 +51,8 @@ add_library(
   frontend/WriteCodec.cpp
   frontend/WriteFunctions.cpp)
 
+set_property(TARGET mvfst_dsr_frontend PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_dsr_frontend PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -76,6 +82,8 @@ add_library(
   mvfst_dsr_backend
   backend/DSRPacketizer.cpp)
 
+set_property(TARGET mvfst_dsr_backend PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_dsr_backend PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/fizz/client/CMakeLists.txt b/quic/fizz/client/CMakeLists.txt
index 885a6f91..c8082b10 100644
--- a/quic/fizz/client/CMakeLists.txt
+++ b/quic/fizz/client/CMakeLists.txt
@@ -9,6 +9,8 @@ add_library(
   handshake/FizzClientHandshake.cpp
 )
 
+set_property(TARGET mvfst_fizz_client PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_fizz_client PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/fizz/handshake/CMakeLists.txt b/quic/fizz/handshake/CMakeLists.txt
index dfb615d2..0645a7d6 100644
--- a/quic/fizz/handshake/CMakeLists.txt
+++ b/quic/fizz/handshake/CMakeLists.txt
@@ -12,6 +12,8 @@ add_library(
   QuicFizzFactory.cpp
 )
 
+set_property(TARGET mvfst_fizz_handshake PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_fizz_handshake PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/flowcontrol/CMakeLists.txt b/quic/flowcontrol/CMakeLists.txt
index 9cb8a983..b1442876 100644
--- a/quic/flowcontrol/CMakeLists.txt
+++ b/quic/flowcontrol/CMakeLists.txt
@@ -8,6 +8,8 @@ add_library(
   QuicFlowController.cpp
 )
 
+set_property(TARGET mvfst_flowcontrol PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_flowcontrol PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/handshake/CMakeLists.txt b/quic/handshake/CMakeLists.txt
index 09607207..43a804d8 100644
--- a/quic/handshake/CMakeLists.txt
+++ b/quic/handshake/CMakeLists.txt
@@ -10,6 +10,8 @@ add_library(
   TransportParameters.cpp
 )
 
+set_property(TARGET mvfst_handshake PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_handshake PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/happyeyeballs/CMakeLists.txt b/quic/happyeyeballs/CMakeLists.txt
index a7f31347..4966f171 100644
--- a/quic/happyeyeballs/CMakeLists.txt
+++ b/quic/happyeyeballs/CMakeLists.txt
@@ -8,6 +8,8 @@ add_library(
   QuicHappyEyeballsFunctions.cpp
 )
 
+set_property(TARGET mvfst_happyeyeballs PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_happyeyeballs PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/logging/CMakeLists.txt b/quic/logging/CMakeLists.txt
index f3a97cff..277847d9 100644
--- a/quic/logging/CMakeLists.txt
+++ b/quic/logging/CMakeLists.txt
@@ -12,6 +12,8 @@ add_library(
   QLoggerTypes.cpp
 )
 
+set_property(TARGET mvfst_qlogger PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_qlogger PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/loss/CMakeLists.txt b/quic/loss/CMakeLists.txt
index 2038db85..51df167a 100644
--- a/quic/loss/CMakeLists.txt
+++ b/quic/loss/CMakeLists.txt
@@ -8,6 +8,8 @@ add_library(
   QuicLossFunctions.cpp
 )
 
+set_property(TARGET mvfst_loss PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_loss PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/observer/CMakeLists.txt b/quic/observer/CMakeLists.txt
index e42ce2f4..6e0b6131 100644
--- a/quic/observer/CMakeLists.txt
+++ b/quic/observer/CMakeLists.txt
@@ -8,6 +8,8 @@ add_library(
   SocketObserverInterface.cpp
 )
 
+set_property(TARGET mvfst_observer PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_observer PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/server/CMakeLists.txt b/quic/server/CMakeLists.txt
index 1f4abb83..4f50d956 100644
--- a/quic/server/CMakeLists.txt
+++ b/quic/server/CMakeLists.txt
@@ -11,6 +11,8 @@ add_library(
   handshake/TokenGenerator.cpp
   state/ServerStateMachine.cpp)
 
+set_property(TARGET mvfst_server_state PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_server_state PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -55,6 +57,8 @@ add_library(
   ../fizz/server/handshake/FizzServerHandshake.cpp
 )
 
+set_property(TARGET mvfst_server PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_server PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -93,6 +97,8 @@ add_library(
   async_tran/QuicServerAsyncTransport.cpp
   )
 
+set_property(TARGET mvfst_server_async_tran PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_server_async_tran PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
diff --git a/quic/state/CMakeLists.txt b/quic/state/CMakeLists.txt
index 95382462..e3b0d5d9 100644
--- a/quic/state/CMakeLists.txt
+++ b/quic/state/CMakeLists.txt
@@ -14,6 +14,8 @@ add_library(
   QuicPriorityQueue.cpp
 )
 
+set_property(TARGET mvfst_state_machine PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_machine PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -55,6 +57,8 @@ add_library(
   AckHandlers.cpp
 )
 
+set_property(TARGET mvfst_state_ack_handler PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_ack_handler PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -91,6 +95,8 @@ add_library(
   DatagramHandlers.cpp
 )
 
+set_property(TARGET mvfst_state_datagram_handler PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_datagram_handler PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -125,6 +131,8 @@ add_library(
   QuicStreamFunctions.cpp
 )
 
+set_property(TARGET mvfst_state_stream_functions PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_stream_functions PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -161,6 +169,8 @@ add_library(
   QuicStateFunctions.cpp
 )
 
+set_property(TARGET mvfst_state_functions PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_functions PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -196,6 +206,8 @@ add_library(
   QuicPacingFunctions.cpp
 )
 
+set_property(TARGET mvfst_state_pacing_functions PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_pacing_functions PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -226,6 +238,8 @@ add_library(
   SimpleFrameFunctions.cpp
 )
 
+set_property(TARGET mvfst_state_simple_frame_functions PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_simple_frame_functions PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -260,6 +274,8 @@ add_library(
   stream/StreamReceiveHandlers.cpp
 )
 
+set_property(TARGET mvfst_state_stream PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_state_stream PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
@@ -297,6 +313,8 @@ add_library(
   TransportSettingsFunctions.cpp
 )
 
+set_property(TARGET mvfst_transport_settings_functions PROPERTY VERSION ${PACKAGE_VERSION})
+
 target_include_directories(
   mvfst_transport_settings_functions PUBLIC
   $<BUILD_INTERFACE:${QUIC_FBCODE_ROOT}>
-- 
2.41.0

